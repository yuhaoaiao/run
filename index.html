<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pose Master: Speed Rush</title>
    <link href="https://gs.jurieo.com/gemini/fonts-googleapis/css2?family=Luckiest+Guy&family=Orbitron:wght@900&display=swap" rel="stylesheet">
    <style>
        :root {
            --ui-blue: #009dff;
            --ui-gold: #ffcc00;
            --ui-red: #ff3344;
        }
        body { margin: 0; background: #000; overflow: hidden; font-family: 'Luckiest Guy', cursive; }
        
        /* --- 3D Âç°ÈÄö HUD --- */
        #ui-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 10; }

        /* È°∂ÈÉ®ÈöæÂ∫¶Êù° */
        #diff-container { position: absolute; top: 30px; left: 50%; transform: translateX(-50%); display: flex; gap: 10px; }
        .diff-tab { 
            padding: 8px 25px; background: #222; color: #fff; border-radius: 5px; 
            font-size: 1.2rem; transform: skewX(-15deg); border: 2px solid #444; transition: 0.3s;
        }
        .diff-tab.active { background: var(--ui-red); border-color: #fff; box-shadow: 0 0 15px var(--ui-red); }
        .diff-tab:nth-child(2).active { background: var(--ui-gold); }
        .diff-tab:nth-child(3).active { background: #6600ff; }
        .diff-tab:nth-child(4).active { background: #000; color: var(--ui-red); border-color: var(--ui-red); }

        /* Â∑¶‰∏ãËßíÔºöÁÅ´ÁÑ∞ËøûÂáª */
        #combo-panel { position: absolute; bottom: 30px; left: 40px; }
        #flame-icon { font-size: 3rem; display: block; animation: fire-shake 0.2s infinite; }
        #combo-text { font-size: 2.5rem; color: #fff; text-shadow: 0 0 10px var(--ui-gold); }
        #combo-bar { width: 150px; height: 10px; background: rgba(255,255,255,0.2); border-radius: 5px; margin-top: 5px; overflow: hidden; }
        #combo-fill { width: 0%; height: 100%; background: linear-gradient(to right, var(--ui-gold), #ff5500); transition: 0.2s; }

        /* Âè≥‰∏ãËßíÔºöÊòüÊòüÂàÜÊï∞ */
        #score-panel { position: absolute; bottom: 30px; right: 40px; text-align: right; }
        #score-val { font-size: 3.5rem; color: var(--ui-gold); -webkit-text-stroke: 2px #332200; }
        #walls-passed { color: #00f2ff; font-size: 1.2rem; }

        /* ‰∏≠Èó¥ÂèçÈ¶à */
        #flash-msg { position: absolute; top: 40%; left: 50%; transform: translate(-50%, -50%) scale(0.5); font-size: 6rem; color: #fff; text-shadow: 0 0 20px var(--ui-blue); opacity: 0; transition: 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        #flash-msg.show { opacity: 1; transform: translate(-50%, -50%) scale(1.2); }

        /* ÊëÑÂÉèÂ§¥Â∞èÁ™ó */
        #video-container { position: absolute; top: 20px; right: 20px; width: 160px; height: 120px; border: 4px solid var(--ui-blue); border-radius: 10px; overflow: hidden; transform: scaleX(-1); }
        
        @keyframes fire-shake { 0% { transform: rotate(-5deg); } 100% { transform: rotate(5deg); } }
        #loading { position: absolute; width: 100%; height: 100%; background: #000; z-index: 100; display: flex; align-items: center; justify-content: center; color: var(--ui-blue); font-size: 2rem; }
    </style>
</head>
<body>

<div id="loading">SYTEM LOADING...</div>

<div id="ui-layer">
    <div id="diff-container">
        <div class="diff-tab active">EASY</div>
        <div class="diff-tab">MEDIUM</div>
        <div class="diff-tab">HARD</div>
        <div class="diff-tab">EXTREME</div>
    </div>

    <div id="combo-panel">
        <span id="flame-icon">üî•</span>
        <div id="combo-text">COMBO X <span id="combo">0</span></div>
        <div id="combo-bar"><div id="combo-fill"></div></div>
    </div>

    <div id="score-panel">
        <div id="score-val">‚òÖ 0000</div>
        <div id="walls-passed">WALLS PASSED: 0</div>
    </div>

    <div id="flash-msg">GREAT!</div>
</div>

<div id="video-container"><video id="video-feed" style="width:100%"></video></div>
<div id="game-canvas"></div>

<script src="https://cdn.jsdelivr.net/npm/@mediapipe/pose/pose.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>
<script type="importmap">
{
    "imports": {
        "three": "https://unpkg.com/three@0.158.0/build/three.module.js",
        "three/addons/": "https://unpkg.com/three@0.158.0/examples/jsm/"
    }
}
</script>

<script type="module">
import * as THREE from 'three';
import { EffectComposer } from 'three/addons/postprocessing/EffectComposer.js';
import { RenderPass } from 'three/addons/postprocessing/RenderPass.js';
import { UnrealBloomPass } from 'three/addons/postprocessing/UnrealBloomPass.js';

// --- ÈÖçÁΩÆ‰∏éÂßøÊÄÅ ---
const POSES = ['T-POSE', 'V-SHAPE', 'L-LEFT', 'L-RIGHT', 'FLEX', 'ARCHER', 'ZEN', 'DAB'];
const getPoseTexture = (name) => {
    const canvas = document.createElement('canvas');
    canvas.width = 512; canvas.height = 512;
    const ctx = canvas.getContext('2d');
    ctx.fillStyle = '#ffffff';
    ctx.font = 'bold 400px Arial';
    ctx.textAlign = 'center';
    ctx.textBaseline = 'middle';
    ctx.fillText('üë§', 256, 256); // ÁÆÄÂçïÂç†‰ΩçÔºåÂÆûÈôÖÂèØÊç¢‰∏∫ Stickman
    return new THREE.CanvasTexture(canvas);
};

// --- 3D ÂºïÊìé ---
let scene, camera, renderer, composer, wall, speedLineTunnel;
let score = 0, combo = 0, gameSpeed = 0.6, wallsPassed = 0;
let currentPose = 'T-POSE';

function init() {
    scene = new THREE.Scene();
    scene.background = new THREE.Color(0x050510);
    camera = new THREE.PerspectiveCamera(75, window.innerWidth/window.innerHeight, 0.1, 1000);
    
    renderer = new THREE.WebGLRenderer({ antialias: true });
    renderer.setSize(window.innerWidth, window.innerHeight);
    document.getElementById('game-canvas').appendChild(renderer.domElement);

    // ËæâÂÖâ
    composer = new EffectComposer(renderer);
    composer.addPass(new RenderPass(scene, camera));
    composer.addPass(new UnrealBloomPass(new THREE.Vector2(window.innerWidth, window.innerHeight), 1.0, 0.4, 0.85));

    // ÈÄüÂ∫¶Á∫øÈößÈÅì
    createSpeedTunnel();
    
    spawnWall();
    camera.position.set(0, 1.6, 8);
    animate();
}

function createSpeedTunnel() {
    const geometry = new THREE.CylinderGeometry(15, 15, 200, 32, 1, true);
    const material = new THREE.MeshBasicMaterial({
        color: 0x0044ff,
        wireframe: true,
        transparent: true,
        opacity: 0.2,
        side: THREE.BackSide
    });
    speedLineTunnel = new THREE.Mesh(geometry, material);
    speedLineTunnel.rotation.x = Math.PI / 2;
    scene.add(speedLineTunnel);
}

function spawnWall() {
    if(wall) scene.remove(wall);
    currentPose = POSES[Math.floor(Math.random() * POSES.length)];
    
    const wallGeo = new THREE.BoxGeometry(10, 10, 0.5);
    const wallMat = new THREE.MeshStandardMaterial({ color: 0x0088ff, emissive: 0x0044ff });
    wall = new THREE.Mesh(wallGeo, wallMat);
    
    // ÊåñÁ©∫Ââ™ÂΩ±ÔºàÁ∫πÁêÜË¥¥ÂõæÊ®°ÊãüÔºâ
    const silGeo = new THREE.PlaneGeometry(6, 6);
    const silMat = new THREE.MeshBasicMaterial({ color: 0xffffff, transparent: true, opacity: 0.9, side: THREE.DoubleSide });
    const silhouette = new THREE.Mesh(silGeo, silMat);
    silhouette.position.z = 0.3;
    wall.add(silhouette);

    wall.position.z = -100;
    scene.add(wall);
}

// --- Ê∏∏ÊàèÂæ™ÁéØ ---
function animate() {
    requestAnimationFrame(animate);
    
    // ÈößÈÅìÊóãËΩ¨‰∏éÂâçËøõÊÑü
    if(speedLineTunnel) {
        speedLineTunnel.rotation.y += 0.01;
        speedLineTunnel.position.z += gameSpeed * 2;
        if(speedLineTunnel.position.z > 50) speedLineTunnel.position.z = 0;
    }

    if(wall) {
        wall.position.z += gameSpeed;
        if(wall.position.z > 10) handleResult(false);
    }

    composer.render();
}

// --- AI Âà§ÂÆö ---
const pose = new Pose({locateFile: (f) => `https://cdn.jsdelivr.net/npm/@mediapipe/pose/${f}`});
pose.onResults(res => {
    document.getElementById('loading').style.display = 'none';
    if(!res.poseLandmarks || !wall || wall.userData.hit) return;
    
    // ÁÆÄÊòìÈÄªËæëÂà§ÂÆöÔºöË∑ùÁ¶ªÁõ∏Êú∫ 3-7 Á±≥Êó∂Êâ´Êèè
    if(wall.position.z > 3 && wall.position.z < 7) {
        // ËøôÈáåË∞ÉÁî®‰Ω†‰πãÂâçÁöÑÁÆóÊ≥ï PoseValidators[currentPose]
        // ÂÅáËÆæÈÄöËøáÔºö
        if(Math.random() > 0.98) handleResult(true); 
    }
});

function handleResult(success) {
    if(wall.userData.hit) return;
    wall.userData.hit = true;

    const msg = document.getElementById('flash-msg');
    if(success) {
        score += 300 + (combo * 50);
        combo++;
        wallsPassed++;
        msg.innerText = "GREAT! +300";
        msg.classList.add('show');
        gameSpeed += 0.01; // Ë∂äÊù•Ë∂äÂø´
    } else {
        combo = 0;
        msg.innerText = "MISS!";
        msg.style.color = "#ff3344";
        msg.classList.add('show');
        gameSpeed = 0.6;
    }

    // Êõ¥Êñ∞ UI
    document.getElementById('score-val').innerText = "‚òÖ " + score.toString().padStart(4, '0');
    document.getElementById('combo').innerText = combo;
    document.getElementById('combo-fill').style.width = Math.min(combo * 10, 100) + "%";
    document.getElementById('walls-passed').innerText = "WALLS PASSED: " + wallsPassed;
    
    updateDiffTabs();

    setTimeout(() => {
        msg.classList.remove('show');
        msg.style.color = "#fff";
        spawnWall();
    }, 600);
}

function updateDiffTabs() {
    const tabs = document.querySelectorAll('.diff-tab');
    tabs.forEach(t => t.classList.remove('active'));
    if(gameSpeed < 0.8) tabs[0].classList.add('active');
    else if(gameSpeed < 1.1) tabs[1].classList.add('active');
    else if(gameSpeed < 1.4) tabs[2].classList.add('active');
    else tabs[3].classList.add('active');
}

const cam = new Camera(document.getElementById('video-feed'), {
    onFrame: async () => { await pose.send({image: document.getElementById('video-feed')}); },
    width: 640, height: 480
});
cam.start();
init();
</script>
</body>
</html>