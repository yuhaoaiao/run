<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pose Master: Pro Edition</title>
    <link href="https://gs.jurieo.com/gemini/fonts-googleapis/css2?family=Luckiest+Guy&family=Orbitron:wght@900&display=swap" rel="stylesheet">
    <style>
        :root { --u-blue: #009dff; --u-gold: #ffcc00; --u-red: #ff3b3b; --u-purple: #9d4eff; }
        body { margin: 0; background: #87ceeb; overflow: hidden; font-family: 'Luckiest Guy', cursive; user-select: none; }
        canvas { display: block; }

        /* é€šç”¨å…¨å±é®ç½© */
        .overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 100; background: rgba(135, 206, 235, 0.9); transition: 0.5s; }
        
        /* å¼€å§‹ä¸ç»“ç®—å¡ç‰‡ */
        .card { background: rgba(255, 255, 255, 0.2); backdrop-filter: blur(15px); padding: 50px; border-radius: 30px; border: 4px solid #fff; text-align: center; color: #fff; box-shadow: 0 20px 50px rgba(0,0,0,0.2); }
        h1 { font-size: 5rem; margin: 0 0 30px 0; text-shadow: 0 5px 0 var(--u-blue); }

        /* éš¾åº¦é€‰æ‹©æŒ‰é’® */
        .difficulty-options { display: flex; gap: 15px; margin-bottom: 30px; }
        .btn-diff { padding: 15px 35px; border: 2px solid #fff; border-radius: 10px; font-family: 'Luckiest Guy'; font-size: 1.5rem; cursor: pointer; color: white; transform: skewX(-15deg); transition: 0.2s; background: #333; pointer-events: auto; }
        .btn-diff span { display: inline-block; transform: skewX(15deg); }
        .btn-diff:hover { transform: skewX(-15deg) scale(1.1); }
        .btn-easy { background: var(--u-blue); }
        .btn-med { background: var(--u-gold); color: #000; }
        .btn-hard { background: var(--u-red); }
        .btn-extreme { background: var(--u-purple); }

        /* æ¸¸æˆè¿è¡Œä¸­çš„ HUD */
        #hud { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 10; display: none; }
        #header-nav { position: absolute; top: 20px; left: 50%; transform: translateX(-50%); display: flex; gap: 5px; pointer-events: auto; }
        .tab { padding: 8px 30px; background: rgba(0,0,0,0.6); transform: skewX(-15deg); border: 2px solid #fff; font-size: 1.1rem; color: white; cursor: pointer; }
        .tab span { display: inline-block; transform: skewX(15deg); }
        .tab.active { background: var(--u-red); box-shadow: 0 0 15px var(--u-red); }

        /* å…¶ä»– UI å…ƒç´  */
        #timer-panel { position: absolute; top: 100px; left: 50%; transform: translateX(-50%); text-align: center; color: #fff; }
        #timer-val { font-size: 4rem; text-shadow: 0 4px 10px rgba(0,0,0,0.3); }
        #score-panel { position: absolute; bottom: 40px; right: 40px; text-align: right; color: #fff; }
        #score-val { font-size: 3.5rem; color: var(--u-gold); -webkit-text-stroke: 1.5px #000; }
        
        #video-container { position: absolute; top: 20px; right: 20px; width: 200px; height: 150px; border: 3px solid #fff; border-radius: 12px; overflow: hidden; transform: scaleX(-1); background: #000; z-index: 50; }
        #input_video { width: 100%; height: 100%; object-fit: contain; } 

        #flash-msg { position: absolute; top: 35%; left: 50%; transform: translate(-50%, -50%); font-size: 6rem; opacity: 0; transition: 0.3s; color: white; }
        #flash-msg.show { opacity: 1; transform: translate(-50%, -50%) scale(1.1); }
    </style>
</head>
<body>

<div id="start-screen" class="overlay">
    <div class="card">
        <h1>POSE MASTER</h1>
        <p style="font-size: 1.5rem; margin-bottom: 30px;">æ¨¡ä»¿å¢™ä¸Šçš„å§¿åŠ¿ï¼Œç©¿è¶Šéšœç¢ï¼</p>
        <div class="difficulty-options">
            <button class="btn-diff btn-easy" onclick="startGame(0.3, 0)"><span>EASY</span></button>
            <button class="btn-diff btn-med" onclick="startGame(0.5, 1)"><span>MEDIUM</span></button>
            <button class="btn-diff btn-hard" onclick="startGame(0.8, 2)"><span>HARD</span></button>
            <button class="btn-diff btn-extreme" onclick="startGame(1.2, 3)"><span>EXTREME</span></button>
        </div>
        <p id="loading-msg" style="font-size: 1rem; color: #eee;">æ­£åœ¨åˆå§‹åŒ– AI å¼•æ“...</p>
    </div>
</div>

<div id="result-screen" class="overlay" style="display: none; background: rgba(0,0,0,0.85);">
    <div class="card" style="border-color: var(--u-gold);">
        <h1 style="color: var(--u-red);">è¯•ç‚¼ç»“æŸ</h1>
        <p style="font-size: 2.5rem; margin: 10px 0;">FINAL SCORE: <span id="final-score" style="color: var(--u-gold);">0000</span></p>
        <p style="font-size: 1.5rem; opacity: 0.8; margin-bottom: 40px;">WALLS PASSED: <span id="final-walls">0</span></p>
        <button class="btn-diff btn-easy" style="transform: none;" onclick="location.reload()"><span>å†æ¬¡æŒ‘æˆ˜</span></button>
    </div>
</div>

<div id="hud">
    <div id="header-nav">
        <div class="tab" onclick="changeDifficulty(0.3, 0)"><span>EASY</span></div>
        <div class="tab" onclick="changeDifficulty(0.5, 1)"><span>MEDIUM</span></div>
        <div class="tab" onclick="changeDifficulty(0.8, 2)"><span>HARD</span></div>
        <div class="tab" onclick="changeDifficulty(1.2, 3)"><span>EXTREME</span></div>
    </div>
    <div id="timer-panel"><div id="timer-val">60</div></div>
    <div style="position: absolute; bottom: 40px; left: 40px; font-size: 2.5rem; color: #fff;">ğŸ”¥ COMBO X <span id="combo-num">0</span></div>
    <div id="score-panel">
        <div id="score-val">â˜… 0000</div>
        <div style="font-size: 1rem;">SPEED: <span id="speed-indicator">1.0</span>x</div>
    </div>
    <div id="flash-msg">GREAT!</div>
</div>

<div id="video-container"><video id="input_video" playsinline muted></video></div>
<div id="game-canvas"></div>

<script src="https://cdn.jsdelivr.net/npm/@mediapipe/pose/pose.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>
<script type="importmap"> { "imports": { "three": "https://unpkg.com/three@0.158.0/build/three.module.js", "three/addons/": "https://unpkg.com/three@0.158.0/examples/jsm/" } } </script>

<script type="module">
import * as THREE from 'three';
import { EffectComposer } from 'three/addons/postprocessing/EffectComposer.js';
import { RenderPass } from 'three/addons/postprocessing/RenderPass.js';
import { UnrealBloomPass } from 'three/addons/postprocessing/UnrealBloomPass.js';

// --- éŸ³æ•ˆå¼•æ“ (Mario Style) ---
const AudioSys = {
    ctx: null,
    init() { if(!this.ctx) this.ctx = new (window.AudioContext || window.webkitAudioContext)(); },
    play(type) {
        if(!this.ctx) return;
        const osc = this.ctx.createOscillator();
        const gain = this.ctx.createGain();
        osc.connect(gain); gain.connect(this.ctx.destination);
        const now = this.ctx.currentTime;
        if (type === 'coin') {
            osc.type = 'square'; osc.frequency.setValueAtTime(987, now); osc.frequency.setValueAtTime(1318, now + 0.