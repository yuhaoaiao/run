<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pose Master: High Fidelity Edition</title>
    <link href="https://gs.jurieo.com/gemini/fonts-googleapis/css2?family=Luckiest+Guy&family=Orbitron:wght@900&display=swap" rel="stylesheet">
    <style>
        :root { --ui-blue: #009dff; --ui-gold: #ffcc00; --ui-red: #ff3344; }
        body { margin: 0; background: #fff; overflow: hidden; font-family: 'Luckiest Guy', cursive; }
        
        #ui-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 10; }

        /* é¡¶éƒ¨éš¾åº¦é¡µç­¾ - æè‡´è¿˜åŸå‚è€ƒå›¾ */
        #header-nav { position: absolute; top: 20px; left: 50%; transform: translateX(-50%); display: flex; gap: 6px; }
        .tab { padding: 8px 30px; background: #2b2b40; color: #fff; transform: skewX(-15deg); border: 2px solid #555; font-size: 1.1rem; transition: 0.3s; }
        .tab span { display: inline-block; transform: skewX(15deg); }
        .tab.active-easy { background: var(--ui-red); border-color: #fff; box-shadow: 0 0 15px var(--ui-red); }
        .tab-med.active { background: var(--ui-gold); color: #000; border-color: #fff; }

        /* ä¸­å¿ƒè®¡æ—¶å™¨ */
        #timer-box { position: absolute; top: 85px; left: 50%; transform: translateX(-50%); text-align: center; color: #fff; }
        #timer-val { font-size: 4.5rem; text-shadow: 0 0 20px rgba(0,0,0,0.5); }

        /* å·¦ä¸‹è§’ï¼šCombo èƒ½é‡æ¡ - 1:1å¤åˆ» */
        #combo-panel { position: absolute; bottom: 40px; left: 45px; }
        #flame { font-size: 3rem; filter: drop-shadow(0 0 10px #ff5500); vertical-align: middle; }
        #combo-text { font-size: 2.5rem; color: #fff; text-shadow: 2px 2px 0 #000; margin-left: 5px; }
        #combo-bar-bg { width: 160px; height: 12px; background: rgba(0,0,0,0.6); border-radius: 6px; border: 2px solid #fff; margin-top: 5px; overflow: hidden; }
        #combo-fill { width: 40%; height: 100%; background: linear-gradient(to right, #ffcc00, #ff4400); transition: 0.3s; }

        /* å³ä¸‹è§’ï¼šæ˜Ÿæ˜Ÿåˆ†æ•° - 1:1å¤åˆ» */
        #score-panel { position: absolute; bottom: 40px; right: 45px; text-align: right; }
        #score-val { font-size: 4rem; color: var(--ui-gold); -webkit-text-stroke: 2px #332200; filter: drop-shadow(0 0 10px rgba(255,204,0,0.5)); }
        #wall-count { font-size: 1.2rem; color: #fff; background: rgba(0,0,0,0.4); padding: 2px 10px; border-radius: 4px; }

        /* æˆåŠŸ/å¤±è´¥å¼¹å‡ºæ¡† */
        #flash-msg { position: absolute; top: 35%; left: 50%; transform: translate(-50%, -50%); font-size: 6rem; color: #fff; text-shadow: 0 0 20px var(--ui-blue), 0 0 40px #fff; opacity: 0; }
        #flash-msg.show { opacity: 1; transform: translate(-50%, -50%) scale(1.1); transition: 0.2s; }

        /* æ‘„åƒå¤´å°çª— - å¸¦è“å…‰è¾¹æ¡† */
        #video-container { position: absolute; top: 20px; right: 20px; width: 180px; height: 135px; border: 3px solid var(--ui-blue); border-radius: 12px; transform: scaleX(-1); box-shadow: 0 0 25px rgba(0,157,255,0.5); overflow: hidden; }
        
        #loading { position: absolute; width: 100%; height: 100%; background: #fff; z-index: 100; display: flex; align-items: center; justify-content: center; color: var(--ui-blue); font-size: 2rem; }
    </style>
</head>
<body>

<div id="loading">POSE MASTER SYSTEM CALIBRATING...</div>

<div id="ui-layer">
    <div id="header-nav">
        <div class="tab active-easy"><span>EASY</span></div>
        <div class="tab tab-med"><span>MEDIUM</span></div>
        <div class="tab"><span>HARD</span></div>
        <div class="tab"><span>EXTREME</span></div>
    </div>
    <div id="timer-box"><div id="timer-val">60</div><div style="font-size: 0.8rem; letter-spacing: 5px;">TIME REMAINING</div></div>
    <div id="combo-panel">
        <span id="flame">ğŸ”¥</span><div id="combo-text">COMBO X<span id="combo-num">4</span></div>
        <div id="combo-bar-bg"><div id="combo-fill"></div></div>
    </div>
    <div id="score-panel">
        <div id="score-val">â˜… 5420</div>
        <div id="wall-count">WALLS PASSED: 3</div>
    </div>
    <div id="flash-msg">GREAT!</div>
</div>

<div id="video-container"><video id="input_video" playsinline></video></div>
<div id="game-canvas"></div>

<script src="https://cdn.jsdelivr.net/npm/@mediapipe/pose/pose.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>
<script type="importmap"> { "imports": { "three": "https://unpkg.com/three@0.158.0/build/three.module.js", "three/addons/": "https://unpkg.com/three@0.158.0/examples/jsm/" } } </script>

<script type="module">
import * as THREE from 'three';
import { EffectComposer } from 'three/addons/postprocessing/EffectComposer.js';
import { RenderPass } from 'three/addons/postprocessing/RenderPass.js';
import { UnrealBloomPass } from 'three/addons/postprocessing/UnrealBloomPass.js';

// --- æè‡´è¿˜åŸç®—æ³•ï¼š6ä¸ªæ ¸å¿ƒåŠ¨ä½œ ---
const getA = (p1, p2) => Math.atan2(p2.y-p1.y, p2.x-p1.x)*(180/Math.PI);
const PoseLogic = {
    'T-POSE': (lm) => Math.abs(getA(lm[11], lm[15])) < 20 && Math.abs(getA(lm[12], lm[16])) > 160,
    'WARRIOR': (lm) => lm[15].y < lm[11].y && lm[16].y > lm[12].y, // å¼“æ­¥å˜ä½“
    'V-SHAPE': (lm) => lm[15].y < lm[11].y && lm[16].y < lm[12].y && Math.abs(lm[15].x - lm[16].x) > 0.4
};
const POSE_KEYS = Object.keys(PoseLogic);
const CONNECTIONS = [[11,12],[11,13],[13,15],[12,14],[14,16],[11,23],[12,24],[23,24],[23,25],[25,27],[24,26],[26,28]];

// --- å¢™ä½“æŒ‡ä»¤ç»˜åˆ¶ï¼šæè‡´ç™½è‰² Stickman ---
function createInstructionTex(poseKey) {
    const canvas = document.createElement('canvas'); canvas.width = 512; canvas.height = 512;
    const ctx = canvas.getContext('2d');
    ctx.fillStyle = '#0088ff'; ctx.fillRect(0,0,512,512); // å‚è€ƒå›¾ä¸­çš„çº¯è“å¢™ä½“
    ctx.strokeStyle = '#ffffff'; ctx.lineWidth = 30; ctx.lineCap = 'round';
    ctx.translate(256, 256); ctx.scale(4.5, 4.5); ctx.translate(-50, -50);
    ctx.beginPath(); ctx.arc(50, 15, 10, 0, Math.PI*2); // å¤´éƒ¨
    if(poseKey === 'T-POSE') { ctx.moveTo(50,45); ctx.lineTo(15,45); ctx.moveTo(50,45); ctx.lineTo(85,45); ctx.moveTo(50,45); ctx.lineTo(50,85); }
    ctx.stroke(); return new THREE.CanvasTexture(canvas);
}

// --- 3D æ¸²æŸ“ä¸ç¯å¢ƒ ---
let scene, camera, renderer, composer, wall, ghostGroup, skeletonLines, speedTunnel;
let score = 5420, combo = 4, wallsPassed = 3, gameSpeed = 0.8;
let currentPose = 'T-POSE';

function init() {
    scene = new THREE.Scene(); scene.background = new THREE.Color(0xe0f7ff); // æ˜äº®çš„èƒŒæ™¯
    camera = new THREE.PerspectiveCamera(75, window.innerWidth/window.innerHeight, 0.1, 1000);
    renderer = new THREE.WebGLRenderer({ antialias: true });
    renderer.setSize(window.innerWidth, window.innerHeight);
    document.getElementById('game-canvas').appendChild(renderer.domElement);

    composer = new EffectComposer(renderer);
    composer.addPass(new RenderPass(scene, camera));
    composer.addPass(new UnrealBloomPass(new THREE.Vector2(window.innerWidth, window.innerHeight), 0.8, 0.4, 0.85));

    // 1. å…·è±¡åŒ–å¹½çµéª¨æ¶ (Skeleton)
    ghostGroup = new THREE.Group();
    for(let i=0; i<33; i++) ghostGroup.add(new THREE.Mesh(new THREE.SphereGeometry(0.12, 12, 12), new THREE.MeshBasicMaterial({ color: 0x00f2ff })));
    skeletonLines = new THREE.LineSegments(new THREE.BufferGeometry(), new THREE.LineBasicMaterial({ color: 0x00f2ff, linewidth: 4 }));
    ghostGroup.add(skeletonLines); scene.add(ghostGroup);

    // 2. æè‡´è¿˜åŸéš§é“ï¼šç™½è‰²å¾„å‘é€Ÿåº¦çº¿
    const tunnelGeo = new THREE.CylinderGeometry(20, 20, 300, 32, 1, true);
    const tunnelMat = new THREE.MeshBasicMaterial({ color: 0xffffff, wireframe: true, transparent: true, opacity: 0.1, side: THREE.BackSide });
    speedTunnel = new THREE.Mesh(tunnelGeo, tunnelMat);
    speedTunnel.rotation.x = Math.PI / 2;
    scene.add(speedTunnel);

    // 3. åœ°æ¿ä¸ç¯å…‰
    const floor = new THREE.GridHelper(400, 80, 0x009dff, 0x009dff);
    floor.position.y = -2; scene.add(floor);
    scene.add(new THREE.AmbientLight(0xffffff, 2), new THREE.DirectionalLight(0xffffff, 1.5));

    camera.position.set(0, 2, 8);
    spawnWall();
}

function spawnWall() {
    if(wall) scene.remove(wall);
    currentPose = POSE_KEYS[Math.floor(Math.random()*POSE_KEYS.length)];
    const group = new THREE.Group();
    // æ‹Ÿç‰©åŒ–åšé‡è“å¢™
    const wallMesh = new THREE.Mesh(new THREE.BoxGeometry(11, 11, 1), new THREE.MeshPhongMaterial({ color: 0x009dff, emissive: 0x004488 }));
    const sil = new THREE.Mesh(new THREE.PlaneGeometry(7.5, 7.5), new THREE.MeshBasicMaterial({ map: createInstructionTex(currentPose), transparent: true }));
    sil.position.z = 0.55; group.add(wallMesh, sil);
    group.position.set(0, 1.5, -120); wall = group; scene.add(wall);
}

// --- AI é©±åŠ¨ ---
const pose = new Pose({locateFile: (f) => `https://cdn.jsdelivr.net/npm/@mediapipe/pose/${f}`});
pose.setOptions({ modelComplexity: 1, minDetectionConfidence: 0.6 });
pose.onResults(res => {
    document.getElementById('loading').style.display = 'none';
    if(!res.poseLandmarks) return;
    const linePos = [];
    res.poseLandmarks.forEach((lm, i) => ghostGroup.children[i].position.set((0.5 - lm.x)*12, (0.5 - lm.y)*10 + 2, 2.5));
    CONNECTIONS.forEach(([i, j]) => {
        const p1 = ghostGroup.children[i].position, p2 = ghostGroup.children[j].position;
        linePos.push(p1.x, p1.y, p1.z, p2.x, p2.y, p2.z);
    });
    skeletonLines.geometry.setAttribute('position', new THREE.Float32BufferAttribute(linePos, 3));
    
    if(wall.position.z > 3 && wall.position.z < 8 && PoseLogic[currentPose](res.poseLandmarks) && !wall.userData.hit) handleSuccess();
});

function handleSuccess() {
    wall.userData.hit = true; score += 300; combo++; wallsPassed++;
    const msg = document.getElementById('flash-msg');
    msg.innerText = "GREAT! +300"; msg.classList.add('show');
    updateUI();
    setTimeout(() => { msg.classList.remove('show'); spawnWall(); }, 600);
}

function updateUI() {
    document.getElementById('score-val').innerText = "â˜… " + score;
    document.getElementById('combo-num').innerText = combo;
    document.getElementById('combo-fill').style.width = Math.min(combo * 10, 100) + "%";
}

function animate() {
    requestAnimationFrame(animate);
    if(speedTunnel) { speedTunnel.rotation.y += 0.02; speedTunnel.position.z += gameSpeed * 5; if(speedTunnel.position.z > 100) speedTunnel.position.z = 0; }
    if(wall) { wall.position.z += gameSpeed * 2; if(wall.position.z > 15) spawnWall(); }
    composer.render();
}

const cam = new Camera(document.getElementById('input_video'), { onFrame: async () => { await pose.send({image: document.getElementById('input_video')}); }, width: 640, height: 480 });
init(); cam.start(); animate();
</script>
</body>
</html>