<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pose Master: 60s Challenge</title>
    <link href="https://gs.jurieo.com/gemini/fonts-googleapis/css2?family=Luckiest+Guy&family=Orbitron:wght@900&display=swap" rel="stylesheet">
    <style>
        :root { --ui-blue: #009dff; --ui-gold: #ffcc00; --ui-red: #ff3344; }
        body { margin: 0; background: #050510; overflow: hidden; font-family: 'Luckiest Guy', cursive; color: white; }
        
        /* --- UI Overlay --- */
        #ui-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 10; }
        
        /* ÂÄíËÆ°Êó∂Èù¢Êùø */
        #timer-panel { position: absolute; top: 80px; left: 50%; transform: translateX(-50%); text-align: center; }
        #timer-val { font-size: 4rem; color: #fff; text-shadow: 0 0 20px var(--ui-blue); }
        #timer-label { font-size: 1rem; letter-spacing: 5px; color: var(--ui-blue); }

        #diff-container { position: absolute; top: 20px; left: 50%; transform: translateX(-50%); display: flex; gap: 10px; }
        .diff-tab { padding: 5px 20px; background: #222; border-radius: 5px; font-size: 1rem; transform: skewX(-15deg); border: 1px solid #444; opacity: 0.5; }
        .diff-tab.active { opacity: 1; background: var(--ui-red); border-color: #fff; box-shadow: 0 0 15px var(--ui-red); }
        
        #combo-panel { position: absolute; bottom: 30px; left: 40px; }
        #score-panel { position: absolute; bottom: 30px; right: 40px; text-align: right; }
        #score-val { font-size: 3.5rem; color: var(--ui-gold); }

        /* ÁªìÁÆóÁïåÈù¢ */
        #game-over { 
            position: absolute; width: 100%; height: 100%; background: rgba(0,0,0,0.9); 
            z-index: 200; display: none; flex-direction: column; align-items: center; justify-content: center; 
            backdrop-filter: blur(10px);
        }
        .result-card { text-align: center; padding: 40px; border: 4px solid var(--ui-gold); border-radius: 20px; background: #111; }
        .restart-btn { 
            margin-top: 30px; padding: 15px 40px; background: var(--ui-blue); color: #fff; 
            border: none; border-radius: 50px; font-family: 'Luckiest Guy'; font-size: 1.5rem; cursor: pointer; pointer-events: auto;
        }

        #flash-msg { position: absolute; top: 40%; left: 50%; transform: translate(-50%, -50%) scale(0.5); font-size: 6rem; opacity: 0; transition: 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        #flash-msg.show { opacity: 1; transform: translate(-50%, -50%) scale(1.1); }

        #video-container { position: absolute; top: 20px; right: 20px; width: 160px; height: 120px; border: 3px solid var(--ui-blue); border-radius: 10px; overflow: hidden; transform: scaleX(-1); opacity: 0.8; }
        
        #loading { position: absolute; width: 100%; height: 100%; background: #000; z-index: 100; display: flex; flex-direction: column; align-items: center; justify-content: center; }
    </style>
</head>
<body>

<div id="game-over">
    <div class="result-card">
        <h1 style="color: var(--ui-red); font-size: 4rem; margin: 0;">TIME UP!</h1>
        <p style="font-size: 2rem; margin: 20px 0;">FINAL SCORE: <span id="final-score" style="color: var(--ui-gold);">0</span></p>
        <p style="font-size: 1.5rem; opacity: 0.8;">MAX COMBO: <span id="max-combo">0</span></p>
        <button class="restart-btn" onclick="location.reload()">RETRY CHALLENGE</button>
    </div>
</div>

<div id="loading">
    <div id="status">INITIALIZING AI...</div>
    <p style="font-size: 1rem; margin-top: 20px;">ËØ∑Á°Æ‰øùÂÖâÁ∫øÂÖÖË∂≥Âπ∂ÂÖÅËÆ∏ÊëÑÂÉèÂ§¥ÊùÉÈôê</p>
</div>

<div id="ui-layer">
    <div id="diff-container">
        <div class="diff-tab active">EASY</div>
        <div class="diff-tab">MEDIUM</div>
        <div class="diff-tab">HARD</div>
        <div class="diff-tab">EXTREME</div>
    </div>

    <div id="timer-panel">
        <div id="timer-val">60</div>
        <div id="timer-label">SECONDS LEFT</div>
    </div>

    <div id="combo-panel">
        <span style="font-size: 3rem;">üî•</span>
        <div style="font-size: 2.5rem;">COMBO X <span id="combo-num">0</span></div>
    </div>

    <div id="score-panel">
        <div id="score-val">‚òÖ 0000</div>
        <div style="color: var(--ui-blue);">SPEED: <span id="speed-indicator">1.0</span>x</div>
    </div>
    
    <div id="flash-msg">GREAT!</div>
</div>

<div id="video-container"><video id="input_video" style="width:100%; height:100%; object-fit: cover;"></video></div>
<div id="game-canvas"></div>

<script src="https://cdn.jsdelivr.net/npm/@mediapipe/pose/pose.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>

<script type="importmap">
{
    "imports": {
        "three": "https://unpkg.com/three@0.158.0/build/three.module.js",
        "three/addons/": "https://unpkg.com/three@0.158.0/examples/jsm/"
    }
}
</script>

<script type="module">
import * as THREE from 'three';
import { EffectComposer } from 'three/addons/postprocessing/EffectComposer.js';
import { RenderPass } from 'three/addons/postprocessing/RenderPass.js';
import { UnrealBloomPass } from 'three/addons/postprocessing/UnrealBloomPass.js';

// --- ÂßøÊÄÅÂÆö‰πâ ---
const getAngle = (p1, p2) => Math.atan2(p2.y - p1.y, p2.x - p1.x) * (180 / Math.PI);
const PoseValidators = {
    'T-POSE': (lm) => Math.abs(getAngle(lm[11], lm[15])) < 25 && Math.abs(getAngle(lm[12], lm[16])) > 155,
    'V-SHAPE': (lm) => lm[15].y < lm[11].y && lm[16].y < lm[12].y,
    'FLEX': (lm) => lm[15].y < lm[13].y && lm[16].y < lm[14].y,
    'ZEN': (lm) => Math.hypot(lm[15].x-lm[16].x, lm[15].y-lm[16].y) < 0.15
};
const POSES = Object.keys(PoseValidators);

// --- Ê∏∏ÊàèÂèòÈáè ---
let scene, camera, renderer, composer, wall, tunnel;
let score = 0, combo = 0, maxCombo = 0, gameSpeed = 0.6, isHit = false;
let timeLeft = 60, isGameOver = false, gameStarted = false;
let currentPoseKey = 'T-POSE';

async function init3D() {
    scene = new THREE.Scene();
    scene.fog = new THREE.FogExp2(0x050510, 0.05);
    camera = new THREE.PerspectiveCamera(75, window.innerWidth/window.innerHeight, 0.1, 1000);
    renderer = new THREE.WebGLRenderer({ antialias: true });
    renderer.setSize(window.innerWidth, window.innerHeight);
    document.getElementById('game-canvas').appendChild(renderer.domElement);

    composer = new EffectComposer(renderer);
    composer.addPass(new RenderPass(scene, camera));
    composer.addPass(new UnrealBloomPass(new THREE.Vector2(window.innerWidth, window.innerHeight), 1.2, 0.4, 0.85));

    const tunnelGeo = new THREE.CylinderGeometry(15, 15, 300, 32, 1, true);
    const tunnelMat = new THREE.MeshBasicMaterial({ color: 0x0066ff, wireframe: true, transparent: true, opacity: 0.1, side: THREE.BackSide });
    tunnel = new THREE.Mesh(tunnelGeo, tunnelMat);
    tunnel.rotation.x = Math.PI / 2;
    scene.add(tunnel);

    camera.position.set(0, 1.8, 8);
    spawnWall();
}

function spawnWall() {
    if(wall) scene.remove(wall);
    currentPoseKey = POSES[Math.floor(Math.random() * POSES.length)];
    const group = new THREE.Group();
    const wallGeo = new THREE.BoxGeometry(12, 12, 0.2);
    const wallMat = new THREE.MeshPhongMaterial({ color: 0x0088ff, transparent: true, opacity: 0.4 });
    const silMesh = new THREE.Mesh(new THREE.PlaneGeometry(6,6), new THREE.MeshBasicMaterial({color: 0xffffff, transparent: true}));
    silMesh.position.z = 0.15;
    group.add(new THREE.Mesh(wallGeo, wallMat), silMesh);
    group.position.z = -120;
    wall = group; isHit = false;
    scene.add(wall);
}

function startTimer() {
    const timer = setInterval(() => {
        if (timeLeft <= 0) {
            clearInterval(timer);
            endGame();
        } else {
            timeLeft--;
            document.getElementById('timer-val').innerText = timeLeft;
            if (timeLeft < 10) document.getElementById('timer-val').style.color = "var(--ui-red)";
        }
    }, 1000);
}

function endGame() {
    isGameOver = true;
    document.getElementById('game-over').style.display = 'flex';
    document.getElementById('final-score').innerText = score;
    document.getElementById('max-combo').innerText = maxCombo;
}

function triggerResult(success) {
    if (isHit || isGameOver) return;
    isHit = true;
    const msg = document.getElementById('flash-msg');
    if(success) {
        score += 300; combo++;
        if(combo > maxCombo) maxCombo = combo;
        timeLeft += 2; // PERFECT Â•ñÂä± 2 Áßí
        msg.innerText = "GREAT! +2s";
        msg.style.color = "var(--ui-gold)";
        gameSpeed += 0.01;
    } else {
        combo = 0;
        msg.innerText = "MISS!";
        msg.style.color = "var(--ui-red)";
        gameSpeed = 0.6;
    }
    msg.classList.add('show');
    updateUI();
    setTimeout(() => { msg.classList.remove('show'); spawnWall(); }, 600);
}

function updateUI() {
    document.getElementById('score-val').innerText = "‚òÖ " + score.toString().padStart(4, '0');
    document.getElementById('combo-num').innerText = combo;
    document.getElementById('speed-indicator').innerText = (gameSpeed/0.6).toFixed(1);
    const tabs = document.querySelectorAll('.diff-tab');
    tabs.forEach(t => t.classList.remove('active'));
    const idx = Math.min(Math.floor((gameSpeed - 0.6) / 0.3), 3);
    tabs[idx].classList.add('active');
}

async function setupAI() {
    const pose = new Pose({locateFile: (f) => `https://cdn.jsdelivr.net/npm/@mediapipe/pose/${f}`});
    pose.setOptions({ modelComplexity: 1, minDetectionConfidence: 0.5 });
    pose.onResults((results) => {
        if (!results.poseLandmarks || isGameOver) return;
        if (!gameStarted) {
            gameStarted = true;
            document.getElementById('loading').style.display = 'none';
            startTimer();
        }
        if (isHit) return;
        const matched = PoseValidators[currentPoseKey](results.poseLandmarks);
        if (wall.position.z > 3 && wall.position.z < 7.5 && matched) triggerResult(true);
    });

    const cam = new Camera(document.getElementById('input_video'), {
        onFrame: async () => { await pose.send({image: document.getElementById('input_video')}); },
        width: 640, height: 480
    });
    cam.start();
}

function animate() {
    if (isGameOver) return;
    requestAnimationFrame(animate);
    if(tunnel) {
        tunnel.rotation.y += 0.01;
        tunnel.position.z += gameSpeed * 2;
        if(tunnel.position.z > 100) tunnel.position.z = 0;
    }
    if(wall) {
        wall.position.z += gameSpeed;
        if(wall.position.z > 10 && !isHit) triggerResult(false);
    }
    composer.render();
}

window.onload = () => { init3D(); setupAI(); animate(); };
</script>
</body>
</html>