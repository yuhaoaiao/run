<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pose Master: Trial of the Wild</title>
    <link href="https://gs.jurieo.com/gemini/fonts-googleapis/css2?family=Noto+Serif+SC:wght@300;700&family=Cinzel:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --sheikah-blue: rgba(0, 255, 255, 0.8);
            --ancient-gold: rgba(255, 215, 0, 0.9);
            --bg-dark: #050b10;
        }
        body { margin: 0; background: var(--bg-dark); overflow: hidden; font-family: 'Noto Serif SC', serif; color: white; }
        
        /* --- 塞尔达风格 HUD --- */
        #ui-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 10; }
        
        /* 顶部进度条 - 模仿精力槽/任务状态 */
        .top-header { position: absolute; top: 40px; width: 100%; text-align: center; }
        .pose-title { 
            font-family: 'Cinzel', serif; font-size: 1.2rem; letter-spacing: 8px; 
            color: var(--ancient-gold); text-shadow: 0 0 10px rgba(255,215,0,0.5);
            margin-bottom: 10px;
        }

        /* 分数显示 - 极简排版 */
        #score-panel { position: absolute; bottom: 50px; right: 60px; text-align: right; border-right: 1px solid var(--sheikah-blue); padding-right: 20px; }
        .label { font-size: 0.8rem; letter-spacing: 3px; opacity: 0.7; margin-bottom: 5px; }
        #score { font-family: 'Cinzel', serif; font-size: 3rem; font-weight: 400; color: #fff; }

        /* 连击反馈 - 环形进度感 */
        #combo-container { position: absolute; bottom: 50px; left: 60px; display: flex; align-items: flex-end; }
        #combo-wheel { width: 60px; height: 60px; border: 2px solid var(--sheikah-blue); border-radius: 50%; display: flex; align-items: center; justify-content: center; margin-right: 15px; position: relative; }
        #combo-wheel::after { content: ''; position: absolute; width: 70px; height: 70px; border: 1px dashed var(--sheikah-blue); border-radius: 50%; animation: rotate 10s linear infinite; }
        #combo { font-family: 'Cinzel', serif; font-size: 1.8rem; }

        /* 提示文字 - 仿游戏大标题弹出 */
        #flash-msg { 
            position: absolute; top: 35%; left: 50%; transform: translate(-50%, -50%);
            width: 100%; text-align: center; pointer-events: none;
        }
        .msg-main { 
            font-size: 4.5rem; letter-spacing: 20px; font-weight: 700;
            background: linear-gradient(to bottom, #fff 40%, var(--ancient-gold));
            -webkit-background-clip: text; -webkit-text-fill-color: transparent;
            opacity: 0; transition: 0.8s cubic-bezier(0.2, 0, 0.2, 1);
            filter: drop-shadow(0 0 15px rgba(0,255,255,0.3));
        }
        .msg-sub { font-size: 1rem; letter-spacing: 15px; color: var(--ancient-gold); opacity: 0; transition: 1s; margin-top: 10px; text-transform: uppercase; }

        /* 摄像头预览 - 希卡石边框 */
        #video-container { 
            position: absolute; top: 30px; right: 30px; width: 160px; 
            border: 1px solid var(--sheikah-blue); padding: 3px; background: rgba(0,0,0,0.3);
            border-radius: 2px; box-shadow: 0 0 20px rgba(0,255,255,0.1);
        }
        #video-preview { width: 100%; display: block; transform: scaleX(-1); filter: contrast(1.1) brightness(1.1); }

        @keyframes rotate { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        
        #loading { position: absolute; width: 100%; height: 100%; background: #000; z-index: 100; display: flex; align-items: center; justify-content: center; letter-spacing: 5px; color: var(--sheikah-blue); }
    </style>
</head>
<body>

<div id="loading">POSE TRIAL INITIALIZING...</div>

<div id="ui-layer">
    <div class="top-header">
        <div class="pose-title">TRIAL OF ANCIENT POSE</div>
        <div style="width: 200px; height: 1px; background: linear-gradient(to right, transparent, var(--ancient-gold), transparent); margin: 0 auto;"></div>
    </div>

    <div id="score-panel">
        <div class="label">RUPEES COLLECTED</div>
        <div id="score">00000</div>
    </div>

    <div id="combo-container">
        <div id="combo-wheel"><span id="combo">0</span></div>
        <div>
            <div class="label" style="margin:0">COMBO</div>
            <div style="width: 100px; height: 2px; background: var(--sheikah-blue);"></div>
        </div>
    </div>

    <div id="flash-msg">
        <div class="msg-main" id="m-main">PURIFIED</div>
        <div class="msg-sub" id="m-sub">The trial continues</div>
    </div>
</div>

<div id="video-container">
    <video id="video-preview" autoplay playsinline></video>
</div>

<div id="game-canvas"></div>

<script src="https://cdn.jsdelivr.net/npm/@mediapipe/pose/pose.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>
<script type="importmap">
{
    "imports": {
        "three": "https://unpkg.com/three@0.158.0/build/three.module.js",
        "three/addons/": "https://unpkg.com/three@0.158.0/examples/jsm/"
    }
}
</script>

<script type="module">
import * as THREE from 'three';
import { EffectComposer } from 'three/addons/postprocessing/EffectComposer.js';
import { RenderPass } from 'three/addons/postprocessing/RenderPass.js';
import { UnrealBloomPass } from 'three/addons/postprocessing/UnrealBloomPass.js';

// ========================
// 1. 希卡风格指令绘制 (Ancient Runes)
// ========================
const POSE_DEFS = {
    'T-POSE': (ctx) => { runeLine(ctx, 50,45, 15,45); runeLine(ctx, 50,45, 85,45); runeLine(ctx, 50,45, 50,85); },
    'V-SHAPE': (ctx) => { runeLine(ctx, 50,50, 20,20); runeLine(ctx, 50,50, 80,20); runeLine(ctx, 50,50, 50,85); },
    'L-RIGHT': (ctx) => { runeLine(ctx, 50,50, 50,15); runeLine(ctx, 50,50, 85,50); runeLine(ctx, 50,50, 50,85); },
    'FLEX': (ctx) => { runeLine(ctx, 50,55, 30,35); runeLine(ctx, 30,35, 40,15); runeLine(ctx, 50,55, 70,35); runeLine(ctx, 70,35, 60,15); runeLine(ctx, 50,55, 50,90); },
    'ZEN': (ctx) => { ctx.arc(50, 55, 12, 0, Math.PI*2); runeLine(ctx, 50,67, 50,90); },
    'ARCHER': (ctx) => { runeLine(ctx, 15,50, 60,50); runeLine(ctx, 60,50, 75,30); runeLine(ctx, 75,30, 70,15); runeLine(ctx, 50,50, 50,85); }
};

function runeLine(ctx, x1, y1, x2, y2) {
    ctx.moveTo(x1, y1); ctx.lineTo(x2, y2);
    // 在关节点画小圆点增加精致感
    ctx.save(); ctx.fillStyle = '#00f2ff';
    ctx.beginPath(); ctx.arc(x2, y2, 2, 0, Math.PI*2); ctx.fill();
    ctx.restore();
}

function createAncientTexture(poseKey) {
    const canvas = document.createElement('canvas');
    canvas.width = 512; canvas.height = 512;
    const ctx = canvas.getContext('2d');
    
    // 背景：带纹理的半透明蓝色
    ctx.fillStyle = 'rgba(0, 40, 60, 0.6)';
    ctx.fillRect(0, 0, 512, 512);

    // 装饰框
    ctx.strokeStyle = 'rgba(0, 255, 255, 0.5)';
    ctx.lineWidth = 4;
    ctx.strokeRect(20, 20, 472, 472);

    // 绘制古代符文小人
    ctx.strokeStyle = '#00f2ff';
    ctx.lineWidth = 8;
    ctx.shadowBlur = 20;
    ctx.shadowColor = '#00f2ff';

    ctx.scale(5.12, 5.12);
    ctx.beginPath();
    ctx.arc(50, 20, 6, 0, Math.PI * 2); // 头部
    POSE_DEFS[poseKey](ctx);
    ctx.stroke();

    return new THREE.CanvasTexture(canvas);
}

// ========================
// 2. 判定算法 (优化版)
// ========================
function getAngle(p1, p2) { return Math.atan2(p2.y - p1.y, p2.x - p1.x) * (180 / Math.PI); }
const PoseValidators = {
    'T-POSE': (lm) => Math.abs(getAngle(lm[11], lm[15])) < 25 && Math.abs(getAngle(lm[12], lm[16])) > 155,
    'V-SHAPE': (lm) => lm[15].y < lm[11].y && lm[16].y < lm[12].y,
    'L-RIGHT': (lm) => Math.abs(getAngle(lm[12], lm[16])) > 150 && lm[15].y < lm[11].y,
    'FLEX': (lm) => lm[15].y < lm[13].y && lm[16].y < lm[14].y,
    'ZEN': (lm) => Math.hypot(lm[15].x-lm[16].x, lm[15].y-lm[16].y) < 0.15,
    'ARCHER': (lm) => Math.abs(getAngle(lm[11], lm[15])) < 30 || Math.abs(getAngle(lm[12], lm[16])) > 150
};

// ========================
// 3. 3D 环境与后期
// ========================
let scene, camera, renderer, composer, wallGroup, envParticles;
let currentPoseKey = 'T-POSE', score = 0, combo = 0, speed = 0.5;

function init() {
    scene = new THREE.Scene();
    scene.fog = new THREE.FogExp2(0x050b10, 0.03);

    camera = new THREE.PerspectiveCamera(60, window.innerWidth/window.innerHeight, 0.1, 1000);
    renderer = new THREE.WebGLRenderer({ antialias: true });
    renderer.setSize(window.innerWidth, window.innerHeight);
    document.getElementById('game-canvas').appendChild(renderer.domElement);

    // 塞尔达式的柔和辉光
    composer = new EffectComposer(renderer);
    composer.addPass(new RenderPass(scene, camera));
    const bloom = new UnrealBloomPass(new THREE.Vector2(window.innerWidth, window.innerHeight), 1.2, 0.4, 0.9);
    composer.addPass(bloom);

    // 绘制地面 - 模仿神庙地板
    const floorGeo = new THREE.PlaneGeometry(1000, 1000);
    const floorMat = new THREE.MeshPhongMaterial({ color: 0x0a1520, specular: 0x00ffff, shininess: 50 });
    const floor = new THREE.Mesh(floorGeo, floorMat);
    floor.rotation.x = -Math.PI / 2;
    scene.add(floor);

    const grid = new THREE.GridHelper(400, 80, 0x00ffff, 0x001122);
    grid.position.y = 0.05;
    scene.add(grid);

    // 增加环境浮游粒子
    addEnvParticles();

    // 灯光
    const sun = new THREE.DirectionalLight(0x00ffff, 1);
    sun.position.set(5, 10, 5);
    scene.add(sun, new THREE.AmbientLight(0x102030));

    spawnWall();
    camera.position.set(0, 2, 10);
    animate();
}

function addEnvParticles() {
    const geo = new THREE.BufferGeometry();
    const pos = [];
    for(let i=0; i<500; i++) {
        pos.push(Math.random()*40-20, Math.random()*10, Math.random()*100-80);
    }
    geo.setAttribute('position', new THREE.Float32BufferAttribute(pos, 3));
    const mat = new THREE.PointsMaterial({ size: 0.05, color: 0x00ffff, transparent: true, opacity: 0.5 });
    envParticles = new THREE.Points(geo, mat);
    scene.add(envParticles);
}

function spawnWall() {
    if(wallGroup) scene.remove(wallGroup);
    
    currentPoseKey = Object.keys(POSE_DEFS)[Math.floor(Math.random() * Object.keys(POSE_DEFS).length)];
    const texture = createAncientTexture(currentPoseKey);

    wallGroup = new THREE.Group();
    
    // 墙体 - 模仿古代能量屏障
    const wallGeo = new THREE.BoxGeometry(10, 10, 0.1);
    const wallMat = new THREE.MeshPhongMaterial({ 
        color: 0x00ffff, transparent: true, opacity: 0.2,
        emissive: 0x00ffff, emissiveIntensity: 0.5
    });
    const wallBase = new THREE.Mesh(wallGeo, wallMat);
    
    // 符文指令
    const silGeo = new THREE.PlaneGeometry(5, 5);
    const silMat = new THREE.MeshBasicMaterial({ map: texture, transparent: true, side: THREE.DoubleSide });
    const silhouette = new THREE.Mesh(silGeo, silMat);
    silhouette.position.z = 0.06;

    wallGroup.add(wallBase, silhouette);
    wallGroup.position.set(0, 1.8, -100);
    scene.add(wallGroup);
}

// MediaPipe 接入
const pose = new Pose({locateFile: (f) => `https://cdn.jsdelivr.net/npm/@mediapipe/pose/${f}`});
pose.setOptions({ modelComplexity: 1, minDetectionConfidence: 0.6 });
pose.onResults(res => {
    document.getElementById('loading').style.display = 'none';
    if(!res.poseLandmarks || !wallGroup || wallGroup.userData.hit) return;
    
    if(wallGroup.position.z > 4 && wallGroup.position.z < 8) {
        if(PoseValidators[currentPoseKey](res.poseLandmarks)) handleResult(true);
    }
});

function handleResult(isSuccess) {
    wallGroup.userData.hit = true;
    const mMain = document.getElementById('m-main');
    const mSub = document.getElementById('m-sub');

    if(isSuccess) {
        score += 100; combo++;
        mMain.innerText = "PURIFIED";
        mMain.style.background = "linear-gradient(to bottom, #fff, var(--ancient-gold))";
        mMain.style.webkitBackgroundClip = "text";
        speed += 0.01;
    } else {
        combo = 0;
        mMain.innerText = "FAILED";
        mMain.style.background = "linear-gradient(to bottom, #fff, #ff4400)";
        mMain.style.webkitBackgroundClip = "text";
        speed = 0.5;
    }

    // 优雅的文字动画
    mMain.parentElement.style.opacity = 0; // 重置
    setTimeout(() => {
        mMain.style.opacity = 1; mMain.style.letterSpacing = "20px";
        mSub.style.opacity = 1; mSub.style.letterSpacing = "15px";
        mMain.parentElement.style.opacity = 1;
    }, 50);

    setTimeout(() => {
        mMain.style.opacity = 0; mSub.style.opacity = 0;
        mMain.style.letterSpacing = "40px"; // 扩散消失
    }, 1200);
    
    document.getElementById('score').innerText = score.toString().padStart(5, '0');
    document.getElementById('combo').innerText = combo;
    spawnWall();
}

function animate() {
    requestAnimationFrame(animate);
    if(wallGroup) {
        wallGroup.position.z += speed;
        if(wallGroup.position.z > 12 && !wallGroup.userData.hit) handleResult(false);
    }
    // 粒子微动
    if(envParticles) envParticles.position.z += 0.1;
    composer.render();
}

const cam = new Camera(document.getElementById('video-preview'), {
    onFrame: async () => { await pose.send({image: document.getElementById('video-preview')}); },
    width: 640, height: 480
});
cam.start();
init();
</script>
</body>
</html>