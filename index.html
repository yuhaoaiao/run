<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pose Master: City Park Rush</title>
    <link href="https://gs.jurieo.com/gemini/fonts-googleapis/css2?family=Luckiest+Guy&family=Orbitron:wght@900&display=swap" rel="stylesheet">
    <style>
        :root { --u-blue: #009dff; --u-gold: #ffcc00; --u-red: #ff3b3b; }
        body { margin: 0; background: #87ceeb; overflow: hidden; font-family: 'Luckiest Guy', cursive; }
        #ui-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 10; color: white; }
        #header-nav { position: absolute; top: 20px; left: 50%; transform: translateX(-50%); display: flex; gap: 5px; }
        .tab { padding: 8px 30px; background: rgba(0,0,0,0.6); transform: skewX(-15deg); border: 2px solid #fff; font-size: 1.1rem; }
        .tab span { display: inline-block; transform: skewX(15deg); }
        .tab.active { background: var(--u-red); box-shadow: 0 0 15px var(--u-red); }
        #timer-panel { position: absolute; top: 90px; left: 50%; transform: translateX(-50%); text-align: center; }
        #timer-val { font-size: 4rem; text-shadow: 0 4px 10px rgba(0,0,0,0.3); }
        #score-panel { position: absolute; bottom: 40px; right: 40px; text-align: right; }
        #score-val { font-size: 3.5rem; color: var(--u-gold); -webkit-text-stroke: 1.5px #000; }
        #video-container { position: absolute; top: 20px; right: 20px; width: 180px; height: 135px; border: 3px solid #fff; border-radius: 12px; overflow: hidden; transform: scaleX(-1); background: #000; box-shadow: 0 4px 20px rgba(0,0,0,0.2); }
        #flash-msg { position: absolute; top: 35%; left: 50%; transform: translate(-50%, -50%); font-size: 6rem; opacity: 0; transition: 0.3s; }
        #flash-msg.show { opacity: 1; transform: translate(-50%, -50%) scale(1.1); }
        #loading { position: absolute; width: 100%; height: 100%; background: #87ceeb; z-index: 100; display: flex; align-items: center; justify-content: center; color: white; font-size: 1.5rem; }
    </style>
</head>
<body>

<div id="loading">æ­£åœ¨å¸ƒç½®å…¬å›­èµ›é“...</div>

<div id="ui-layer">
    <div id="header-nav">
        <div class="tab active"><span>EASY</span></div>
        <div class="tab"><span>MEDIUM</span></div>
        <div class="tab"><span>HARD</span></div>
    </div>
    <div id="timer-panel"><div id="timer-val">60</div></div>
    <div id="combo-panel" style="position: absolute; bottom: 40px; left: 40px;">
        <div style="font-size: 2.5rem;">ğŸ”¥ COMBO X <span id="combo-num">0</span></div>
    </div>
    <div id="score-panel">
        <div id="score-val">â˜… 0000</div>
        <div style="font-size: 1rem;">WALLS PASSED: <span id="walls-passed">0</span></div>
    </div>
    <div id="flash-msg">GREAT!</div>
</div>

<div id="video-container"><video id="input_video" style="width:100%; height:100%; object-fit: cover;"></video></div>
<div id="game-canvas"></div>

<script src="https://cdn.jsdelivr.net/npm/@mediapipe/pose/pose.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>
<script type="importmap"> { "imports": { "three": "https://unpkg.com/three@0.158.0/build/three.module.js", "three/addons/": "https://unpkg.com/three@0.158.0/examples/jsm/" } } </script>

<script type="module">
import * as THREE from 'three';
import { EffectComposer } from 'three/addons/postprocessing/EffectComposer.js';
import { RenderPass } from 'three/addons/postprocessing/RenderPass.js';
import { UnrealBloomPass } from 'three/addons/postprocessing/UnrealBloomPass.js';

// ========================
// 1. æè‡´è¿˜åŸï¼šç²¾ç»†é•‚ç©ºçº¹ç†ç”Ÿæˆå™¨
// ========================
function drawPrecisePerson(ctx, key) {
    ctx.lineWidth = 18; // è°ƒç»†ç”»ç¬”ï¼Œå½¢çŠ¶æ›´ç²¾å‡†
    ctx.lineCap = 'round';
    ctx.lineJoin = 'round';
    ctx.translate(256, 256); ctx.scale(4.2, 4.2); ctx.translate(-50, -50);
    
    ctx.beginPath();
    // å¤´éƒ¨
    ctx.arc(50, 18, 8, 0, Math.PI * 2);
    // é¢ˆéƒ¨è¿æ¥
    ctx.moveTo(50, 26); ctx.lineTo(50, 32);
    
    if(key === 'T-POSE') {
        ctx.moveTo(15, 40); ctx.lineTo(85, 40); // è‡‚
        ctx.moveTo(50, 32); ctx.lineTo(50, 70); // èº¯å¹²
        ctx.moveTo(50, 70); ctx.lineTo(35, 95); ctx.moveTo(50, 70); ctx.lineTo(65, 95); // è…¿
    } else if(key === 'V-SHAPE') {
        ctx.moveTo(50, 32); ctx.lineTo(25, 10); ctx.moveTo(50, 32); ctx.lineTo(75, 10);
        ctx.moveTo(50, 32); ctx.lineTo(50, 70); ctx.moveTo(50, 70); ctx.lineTo(35, 95); ctx.moveTo(50, 70); ctx.lineTo(65, 95);
    } else if(key === 'FLEX') {
        ctx.moveTo(50, 32); ctx.lineTo(25, 30); ctx.lineTo(25, 15);
        ctx.moveTo(50, 32); ctx.lineTo(75, 30); ctx.lineTo(75, 15);
        ctx.moveTo(50, 32); ctx.lineTo(50, 70); ctx.moveTo(50, 70); ctx.lineTo(40, 95); ctx.moveTo(50, 70); ctx.lineTo(60, 95);
    } else if(key === 'L-LEFT') {
        ctx.moveTo(50, 32); ctx.lineTo(50, 5); ctx.moveTo(50, 32); ctx.lineTo(20, 32);
        ctx.moveTo(50, 32); ctx.lineTo(50, 70); ctx.moveTo(50, 70); ctx.lineTo(35, 95); ctx.moveTo(50, 70); ctx.lineTo(65, 95);
    } else {
        // é»˜è®¤åŠ¨ä½œ (Zen/Cross)
        ctx.moveTo(50, 32); ctx.lineTo(35, 50); ctx.lineTo(50, 60); ctx.lineTo(65, 50); ctx.lineTo(50, 32);
        ctx.moveTo(50, 32); ctx.lineTo(50, 75); ctx.moveTo(50, 75); ctx.lineTo(30, 95); ctx.moveTo(50, 75); ctx.lineTo(70, 95);
    }
    ctx.stroke();
}

function createHollowWallTexture(poseKey) {
    const canvas = document.createElement('canvas');
    canvas.width = 512; canvas.height = 512;
    const ctx = canvas.getContext('2d');
    
    // è“è‰²å®ä½“å¢™é¢
    ctx.fillStyle = '#008cff'; ctx.fillRect(0, 0, 512, 512);
    // ç»˜åˆ¶ç™½è‰²è¾¹æ¡†å¢å¼ºå¯¹æ¯”
    ctx.save();
    ctx.globalCompositeOperation = 'source-over';
    ctx.strokeStyle = '#ffffff';
    drawPrecisePerson(ctx, poseKey);
    ctx.restore();
    
    // é•‚ç©º
    ctx.globalCompositeOperation = 'destination-out';
    drawPrecisePerson(ctx, poseKey);
    
    return new THREE.CanvasTexture(canvas);
}

// ========================
// 2. 3D åŸå¸‚å…¬å›­åœºæ™¯
// ========================
let scene, camera, renderer, composer, wall, ghostGroup, skeletonLines;
let track, grass, trees = [];
let score = 0, combo = 0, wallsPassed = 0, timeLeft = 60, gameSpeed = 0.35;
let isGameOver = false, isHit = false, currentPoseKey = 'T-POSE';

function init3D() {
    scene = new THREE.Scene();
    scene.background = new THREE.Color(0x87ceeb); // å¤©ç©ºè“
    scene.fog = new THREE.Fog(0x87ceeb, 20, 120);

    camera = new THREE.PerspectiveCamera(75, window.innerWidth/window.innerHeight, 0.1, 1000);
    renderer = new THREE.WebGLRenderer({ antialias: true });
    renderer.setSize(window.innerWidth, window.innerHeight);
    document.getElementById('game-canvas').appendChild(renderer.domElement);

    composer = new EffectComposer(renderer);
    composer.addPass(new RenderPass(scene, camera));
    composer.addPass(new UnrealBloomPass(new THREE.Vector2(window.innerWidth, window.innerHeight), 0.3, 0.4, 0.85));

    // A. åœ°é¢ç³»ç»Ÿ
    const loader = new THREE.TextureLoader();
    // èµ›é“æè´¨
    const trackTex = loader.load('https://threejs.org/examples/textures/grid.png');
    trackTex.wrapS = trackTex.wrapT = THREE.RepeatWrapping;
    trackTex.repeat.set(1, 20);
    const trackGeo = new THREE.PlaneGeometry(12, 400);
    const trackMat = new THREE.MeshPhongMaterial({ map: trackTex, color: 0x444444 });
    track = new THREE.Mesh(trackGeo, trackMat);
    track.rotation.x = -Math.PI / 2;
    scene.add(track);

    // è‰åªæè´¨
    const grassGeo = new THREE.PlaneGeometry(200, 400);
    const grassMat = new THREE.MeshPhongMaterial({ color: 0x7cfc00 }); // å«©ç»¿è‰²
    grass = new THREE.Mesh(grassGeo, grassMat);
    grass.rotation.x = -Math.PI / 2;
    grass.position.y = -0.1;
    scene.add(grass);

    // B. ä¾§å¢™ (åŠé€æ˜æŠ¤æ )
    const wallGeo = new THREE.PlaneGeometry(1, 400);
    const wallMat = new THREE.MeshPhongMaterial({ color: 0x009dff, transparent: true, opacity: 0.3, side: THREE.DoubleSide });
    const leftRail = new THREE.Mesh(wallGeo, wallMat);
    leftRail.position.set(-6, 0.5, 0); leftRail.rotation.y = Math.PI/2;
    const rightRail = new THREE.Mesh(wallGeo, wallMat);
    rightRail.position.set(6, 0.5, 0); rightRail.rotation.y = -Math.PI/2;
    scene.add(leftRail, rightRail);

    // C. ä½å¤šè¾¹å½¢æ ‘æœ¨
    for(let i=0; i<30; i++) {
        const tree = createTree();
        tree.position.set(i % 2 === 0 ? -15 - Math.random()*5 : 15 + Math.random()*5, 0, -i * 15);
        scene.add(tree);
        trees.push(tree);
    }

    // D. å¹½çµéª¨æ¶
    ghostGroup = new THREE.Group();
    for(let i=0; i<33; i++) ghostGroup.add(new THREE.Mesh(new THREE.SphereGeometry(0.12), new THREE.MeshBasicMaterial({ color: 0x00f2ff })));
    skeletonLines = new THREE.LineSegments(new THREE.BufferGeometry(), new THREE.LineBasicMaterial({ color: 0x00f2ff, linewidth: 3 }));
    ghostGroup.add(skeletonLines);
    scene.add(ghostGroup);

    scene.add(new THREE.AmbientLight(0xffffff, 1.2), new THREE.DirectionalLight(0xffffff, 0.8));
    camera.position.set(0, 3, 10);
    spawnWall();
}

function createTree() {
    const group = new THREE.Group();
    const trunk = new THREE.Mesh(new THREE.CylinderGeometry(0.2, 0.3, 1.5), new THREE.MeshPhongMaterial({ color: 0x8b4513 }));
    trunk.position.y = 0.75;
    const leaves = new THREE.Mesh(new THREE.ConeGeometry(1, 3, 6), new THREE.MeshPhongMaterial({ color: 0x228b22 }));
    leaves.position.y = 2.5;
    group.add(trunk, leaves);
    return group;
}

function spawnWall() {
    if(wall) scene.remove(wall);
    isHit = false;
    currentPoseKey = ['T-POSE', 'V-SHAPE', 'FLEX', 'L-LEFT'][Math.floor(Math.random()*4)];
    const wallGeo = new THREE.BoxGeometry(10, 8, 0.5);
    const hollowTex = createHollowWallTexture(currentPoseKey);
    const mat = new THREE.MeshPhongMaterial({ map: hollowTex, transparent: true });
    wall = new THREE.Mesh(wallGeo, mat);
    wall.position.set(0, 4, -100);
    scene.add(wall);
}

// ========================
// 3. é€»è¾‘ä¸åŠ¨ç”»å¾ªç¯
// ========================
const CONNECTIONS = [[11,12],[11,13],[13,15],[12,14],[14,16],[11,23],[12,24],[23,24],[23,25],[25,27],[24,26],[26,28]];
const getA = (p1, p2) => Math.atan2(p2.y-p1.y, p2.x-p1.x)*(180/Math.PI);

const pose = new Pose({locateFile: (f) => `https://cdn.jsdelivr.net/npm/@mediapipe/pose/${f}`});
pose.setOptions({ modelComplexity: 1, minDetectionConfidence: 0.6 });
pose.onResults(res => {
    document.getElementById('loading').style.display = 'none';
    if(!res.poseLandmarks || isGameOver) return;
    const lp = [];
    res.poseLandmarks.forEach((lm, i) => ghostGroup.children[i].position.set((0.5 - lm.x)*12, (0.5 - lm.y)*10 + 2, 2.5));
    CONNECTIONS.forEach(([i,j]) => {
        const p1 = ghostGroup.children[i].position, p2 =