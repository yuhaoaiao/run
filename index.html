<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pose Master: Ultimate High-Fidelity Parkour</title>
    <link href="https://gs.jurieo.com/gemini/fonts-googleapis/css2?family=Luckiest+Guy&family=Orbitron:wght@900&display=swap" rel="stylesheet">
    <style>
        :root { --u-blue: #009dff; --u-gold: #ffcc00; --u-red: #ff3344; }
        body { margin: 0; background: #000d1a; overflow: hidden; font-family: 'Luckiest Guy', cursive; }
        
        #ui-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 10; color: white; }
        
        /* È°∂ÈÉ®ÂØºËà™ */
        #header-nav { position: absolute; top: 20px; left: 50%; transform: translateX(-50%); display: flex; gap: 8px; }
        .tab { padding: 10px 35px; background: rgba(0,0,0,0.8); transform: skewX(-15deg); border: 2px solid #555; font-size: 1.2rem; transition: 0.3s; opacity: 0.6; }
        .tab span { display: inline-block; transform: skewX(15deg); }
        .tab.active { opacity: 1; background: var(--u-red); border-color: #fff; box-shadow: 0 0 20px var(--u-red); }

        /* ÂÄíËÆ°Êó∂Èù¢Êùø */
        #timer-panel { position: absolute; top: 90px; left: 50%; transform: translateX(-50%); text-align: center; }
        #timer-val { font-size: 5rem; line-height: 1; text-shadow: 0 0 30px rgba(0,0,0,0.8); }

        /* Combo & Score */
        #combo-panel { position: absolute; bottom: 40px; left: 50px; transform: skewX(-10deg); }
        #score-panel { position: absolute; bottom: 40px; right: 50px; text-align: right; transform: skewX(-10deg); }
        #score-val { font-size: 4rem; color: var(--u-gold); -webkit-text-stroke: 2px #000; filter: drop-shadow(0 0 10px rgba(255,204,0,0.5)); }

        /* ËßÜÈ¢ëÈ¢ÑËßà */
        #video-container { position: absolute; top: 20px; right: 20px; width: 200px; height: 150px; border: 3px solid var(--u-blue); border-radius: 12px; overflow: hidden; transform: scaleX(-1); box-shadow: 0 0 25px rgba(0,157,255,0.4); }
        
        #flash-msg { position: absolute; top: 35%; left: 50%; transform: translate(-50%, -50%); font-size: 8rem; color: #fff; text-shadow: 0 0 20px #00f2ff, 0 0 50px #fff; opacity: 0; transition: 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        #flash-msg.show { opacity: 1; transform: translate(-50%, -50%) scale(1.1); }
        
        #loading { position: absolute; width: 100%; height: 100%; background: #000d1a; z-index: 100; display: flex; flex-direction: column; align-items: center; justify-content: center; color: var(--u-blue); font-size: 2rem; }
    </style>
</head>
<body>

<div id="loading">
    <div style="font-size: 4rem; margin-bottom: 20px;">üèÉ‚Äç‚ôÇÔ∏è</div>
    SYNCING HIGH-SPEED ENVIRONMENT...
</div>

<div id="ui-layer">
    <div id="header-nav">
        <div class="tab active"><span>EASY</span></div>
        <div class="tab"><span>MEDIUM</span></div>
        <div class="tab"><span>HARD</span></div>
    </div>
    <div id="timer-panel"><div id="timer-val">60</div><div style="font-size: 1rem; letter-spacing: 5px;">TIME LEFT</div></div>
    <div id="combo-panel">
        <div style="font-size: 3rem;">üî• COMBO X <span id="combo-num">0</span></div>
        <div style="width: 200px; height: 12px; background: rgba(0,0,0,0.5); border: 2px solid #fff; border-radius: 6px; margin-top: 5px; overflow: hidden;">
            <div id="combo-fill" style="width: 0%; height: 100%; background: linear-gradient(to right, #ffcc00, #ff4400); transition: 0.3s;"></div>
        </div>
    </div>
    <div id="score-panel"><div id="score-val">‚òÖ 0000</div><div style="font-size: 1.2rem; color: var(--u-blue);">WALLS PASSED: <span id="walls-passed">0</span></div></div>
    <div id="flash-msg">GREAT!</div>
</div>

<div id="video-container"><video id="input_video" playsinline style="width:100%; height:100%; object-fit: cover;"></video></div>
<div id="game-canvas"></div>

<script src="https://cdn.jsdelivr.net/npm/@mediapipe/pose/pose.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>
<script type="importmap"> { "imports": { "three": "https://unpkg.com/three@0.158.0/build/three.module.js", "three/addons/": "https://unpkg.com/three@0.158.0/examples/jsm/" } } </script>

<script type="module">
import * as THREE from 'three';
import { EffectComposer } from 'three/addons/postprocessing/EffectComposer.js';
import { RenderPass } from 'three/addons/postprocessing/RenderPass.js';
import { UnrealBloomPass } from 'three/addons/postprocessing/UnrealBloomPass.js';

// ========================
// 1. ÂÖ∑Ë±°ÂåñÈïÇÁ©∫Â¢ôÈù¢ÁªòÂà∂ (8‰∏™Âä®‰ΩúÈáçÁªò)
// ========================
function drawSilhouette(ctx, key) {
    ctx.lineWidth = 40; ctx.lineCap = 'round'; ctx.strokeStyle = '#ffffff';
    ctx.translate(256, 256); ctx.scale(4.5, 4.5); ctx.translate(-50, -50);
    ctx.beginPath();
    ctx.arc(50, 18, 12, 0, Math.PI * 2); // Â§¥
    if (key === 'T-POSE') { ctx.moveTo(10, 45); ctx.lineTo(90, 45); ctx.moveTo(50, 45); ctx.lineTo(50, 75); ctx.moveTo(50, 75); ctx.lineTo(30, 95); ctx.moveTo(50, 75); ctx.lineTo(70, 95); }
    else if (key === 'V-SHAPE') { ctx.moveTo(50, 45); ctx.lineTo(20, 20); ctx.moveTo(50, 45); ctx.lineTo(80, 20); ctx.moveTo(50, 45); ctx.lineTo(50, 75); ctx.moveTo(50, 75); ctx.lineTo(35, 95); ctx.moveTo(50, 75); ctx.lineTo(65, 95); }
    else if (key === 'ARCHER') { ctx.moveTo(15, 50); ctx.lineTo(65, 50); ctx.moveTo(65, 50); ctx.lineTo(85, 30); ctx.moveTo(50, 50); ctx.lineTo(50, 80); ctx.moveTo(50, 80); ctx.lineTo(25, 95); ctx.moveTo(50, 80); ctx.lineTo(75, 95); }
    else if (key === 'FLEX') { ctx.moveTo(50, 45); ctx.lineTo(25, 25); ctx.lineTo(35, 10); ctx.moveTo(50, 45); ctx.lineTo(75, 25); ctx.lineTo(65, 10); ctx.moveTo(50, 45); ctx.lineTo(50, 75); ctx.moveTo(50, 75); ctx.lineTo(30, 95); ctx.moveTo(50, 75); ctx.lineTo(70, 95); }
    else if (key === 'L-SHAPE') { ctx.moveTo(50, 45); ctx.lineTo(90, 45); ctx.moveTo(50, 45); ctx.lineTo(50, 10); ctx.moveTo(50, 45); ctx.lineTo(50, 75); ctx.moveTo(50, 75); ctx.lineTo(30, 95); ctx.moveTo(50, 75); ctx.lineTo(70, 95); }
    else if (key === 'ZEN') { ctx.moveTo(50, 45); ctx.lineTo(35, 55); ctx.lineTo(50, 65); ctx.lineTo(65, 55); ctx.lineTo(50, 45); ctx.moveTo(50, 45); ctx.lineTo(50, 90); ctx.moveTo(50, 90); ctx.lineTo(30, 95); ctx.moveTo(50, 90); ctx.lineTo(70, 95); }
    else { ctx.moveTo(50, 45); ctx.lineTo(80, 80); ctx.moveTo(50, 45); ctx.lineTo(20, 10); ctx.moveTo(50, 45); ctx.lineTo(50, 80); ctx.moveTo(50, 80); ctx.lineTo(20, 95); ctx.moveTo(50, 80); ctx.lineTo(80, 95); }
    ctx.stroke(); ctx.fill();
}

function createHollowWallTexture(poseKey) {
    const canvas = document.createElement('canvas'); canvas.width = 512; canvas.height = 512;
    const ctx = canvas.getContext('2d');
    // ‰∫ÆËìùËâ≤Á†ñÂùóÂ¢ôËÉåÊôØ
    ctx.fillStyle = '#008cff'; ctx.fillRect(0, 0, 512, 512);
    ctx.strokeStyle = 'rgba(255,255,255,0.1)'; ctx.lineWidth = 2;
    for(let i=0; i<512; i+=64) { ctx.moveTo(0,i); ctx.lineTo(512,i); ctx.moveTo(i,0); ctx.lineTo(i,512); }
    ctx.stroke();
    // ÈïÇÁ©∫Êìç‰Ωú
    ctx.globalCompositeOperation = 'destination-out';
    drawSilhouette(ctx, poseKey);
    // ËæπÁºòÈ´òÂÖâ
    ctx.globalCompositeOperation = 'source-over';
    ctx.strokeStyle = '#ffffff'; ctx.lineWidth = 15; ctx.shadowBlur = 20; ctx.shadowColor = '#00f2ff';
    drawSilhouette(ctx, poseKey);
    return new THREE.CanvasTexture(canvas);
}

// ========================
// 2. Ë∑ëÈÖ∑Âú∫ÊôØÊûÑÂª∫ (Subway Surfers Style)
// ========================
let scene, camera, renderer, composer, wall, ghostGroup, skeletonLines;
let floor, worldGroup, buildings = [];
let score = 0, combo = 0, wallsPassed = 0, timeLeft = 60, gameSpeed = 0.35;
let isGameOver = false, isHit = false, currentPoseKey = 'T-POSE';

function init3D() {
    scene = new THREE.Scene();
    scene.background = new THREE.Color(0x000d1a);
    scene.fog = new THREE.FogExp2(0x000d1a, 0.02);

    camera = new THREE.PerspectiveCamera(75, window.innerWidth/window.innerHeight, 0.1, 1000);
    renderer = new THREE.WebGLRenderer({ antialias: true });
    renderer.setSize(window.innerWidth, window.innerHeight);
    renderer.outputColorSpace = THREE.SRGBColorSpace;
    document.getElementById('game-canvas').appendChild(renderer.domElement);

    composer = new EffectComposer(renderer);
    composer.addPass(new RenderPass(scene, camera));
    composer.addPass(new UnrealBloomPass(new THREE.Vector2(window.innerWidth, window.innerHeight), 1.2, 0.4, 0.85));

    worldGroup = new THREE.Group();
    scene.add(worldGroup);

    // ËΩ®ÈÅìÂú∞Êùø
    const floorGeo = new THREE.PlaneGeometry(16, 1000);
    const floorMat = new THREE.MeshPhongMaterial({ color: 0x001a33, emissive: 0x008cff, emissiveIntensity: 0.1 });
    floor = new THREE.Mesh(floorGeo, floorMat);
    floor.rotation.x = -Math.PI / 2;
    worldGroup.add(floor);

    // ÁîüÊàê‰∏§‰æßÁöÑÊôØËßÇÂª∫Á≠ë (ÂÖ∑Ë±°Ë∑ëÈÖ∑ÊÑü)
    for (let i = 0; i < 20; i++) {
        const height = Math.random() * 30 + 10;
        const bGeo = new THREE.BoxGeometry(4, height, 4);
        const bMat = new THREE.MeshPhongMaterial({ color: 0x003366, emissive: 0x009dff, emissiveIntensity: Math.random() });
        const b = new THREE.Mesh(bGeo, bMat);
        b.position.set(i % 2 === 0 ? -12 : 12, height / 2, -i * 40);
        worldGroup.add(b);
        buildings.push(b);
    }

    // ÂπΩÁÅµ‰∫∫
    ghostGroup = new THREE.Group();
    for(let i=0; i<33; i++) ghostGroup.add(new THREE.Mesh(new THREE.SphereGeometry(0.15), new THREE.MeshBasicMaterial({ color: 0x00f2ff })));
    skeletonLines = new THREE.LineSegments(new THREE.BufferGeometry(), new THREE.LineBasicMaterial({ color: 0x00f2ff, linewidth: 4 }));
    ghostGroup.add(skeletonLines);
    scene.add(ghostGroup);

    scene.add(new THREE.AmbientLight(0xffffff, 0.5), new THREE.DirectionalLight(0xffffff, 2));
    camera.position.set(0, 4, 12);
    spawnWall();
}

function spawnWall() {
    if(wall) scene.remove(wall);
    isHit = false;
    currentPoseKey = ['T-POSE', 'V-SHAPE', 'ARCHER', 'FLEX', 'L-SHAPE', 'ZEN', 'OTHER'][Math.floor(Math.random()*7)];
    const tex = createHollowWallTexture(currentPoseKey);
    const wallGeo = new THREE.BoxGeometry(12, 12, 1);
    const mats = [
        new THREE.MeshPhongMaterial({ color: 0x0066cc }), new THREE.MeshPhongMaterial({ color: 0x0066cc }),
        new THREE.MeshPhongMaterial({ color: 0x0066cc }), new THREE.MeshPhongMaterial({ color: 0x0066cc }),
        new THREE.MeshPhongMaterial({ map: tex, transparent: true }), // ÂâçÁ´ØÈïÇÁ©∫
        new THREE.MeshPhongMaterial({ color: 0x0066cc })
    ];
    wall = new THREE.Mesh(wallGeo, mats);
    wall.position.set(0, 5, -120);
    scene.add(wall);
}

// ========================
// 3. AI ÈÄªËæë‰∏éÂà§ÂÆöÁ≥ªÁªü
// ========================
const CONNECTIONS = [[11,12],[11,13],[13,15],[12,14],[14,16],[11,23],[12,24],[23,24],[23,25],[25,27],[24,26],[26,28]];
const getA = (p1, p2) => Math.atan2(p2.y-p1.y, p2.x-p1.x)*(180/Math.PI);

const pose = new Pose({locateFile: (f) => `https://cdn.jsdelivr.net/npm/@mediapipe/pose/${f}`});
pose.setOptions({ modelComplexity: 1, minDetectionConfidence: 0.6 });
pose.onResults(res => {
    document.getElementById('loading').style.display = 'none';
    if(!res.poseLandmarks || isGameOver) return;
    const lp = [];
    res.poseLandmarks.forEach((lm, i) => ghostGroup.children[i].position.set((0.5 - lm.x)*14, (0.5 - lm.y)*10 + 2, 3));
    CONNECTIONS.forEach(([i,j]) => {
        const p1 = ghostGroup.children[i].position, p2 = ghostGroup.children[j].position;
        lp.push(p1.x, p1.y, p1.z, p2.x, p2.y, p2.z);
    });
    skeletonLines.geometry.setAttribute('position', new THREE.Float32BufferAttribute(lp, 3));

    const lm = res.poseLandmarks;
    const matched = {
        'T-POSE': () => Math.abs(getA(lm[11], lm[15])) < 25 && Math.abs(getA(lm[12], lm[16])) > 155,
        'V-SHAPE': () => lm[15].y < lm[11].y && lm[16].y < lm[12].y,
        'ARCHER': () => Math.abs(getA(lm[11], lm[15])) < 30 && Math.abs(getA(lm[12], lm[14])) < 90,
        'FLEX': () => lm[15].y < lm[13].y && lm[16].y < lm[14].y,
        'L-SHAPE': () => lm[15].y < lm[11].y && Math.abs(getA(lm[12], lm[16])) < 25,
        'ZEN': () => Math.hypot(lm[15].x-lm[16].x, lm[15].y-lm[16].y) < 0.15,
        'OTHER': () => lm[15].y > lm[11].y && lm[16].y > lm[12].y
    }[currentPoseKey]();

    if(wall.position.z > 2 && wall.position.z < 8 && matched && !isHit) handleResult(true);
});

function handleResult(success) {
    if(isHit) return; isHit = true;
    const msg = document.getElementById('flash-msg');
    if(success) {
        score += 300; combo++; timeLeft += 2; wallsPassed++;
        msg.innerText = "GREAT! +2S"; msg.classList.add('show');
        gameSpeed = Math.min(gameSpeed + 0.015, 1.5);
    } else {
        combo = 0; msg.innerText = "MISS!"; msg.style.color = "var(--u-red)";
        gameSpeed = 0.35;
    }
    document.getElementById('score-val').innerText = "‚òÖ " + score.toString().padStart(4, '0');
    document.getElementById('combo-num').innerText = combo;
    document.getElementById('combo-fill').style.width = Math.min(combo * 10, 100) + "%";
    document.getElementById('walls-passed').innerText = wallsPassed;
    setTimeout(() => { msg.classList.remove('show'); msg.style.color = "white"; spawnWall(); }, 600);
}

function animate() {
    if(isGameOver) return;
    requestAnimationFrame(animate);
    
    // ÊôØËßÇÊó†ÈôêÊªöÂä®
    buildings.forEach(b => {
        b.position.z += gameSpeed * 5;
        if(b.position.z > 20) b.position.z = -380;
    });

    if(wall) {
        wall.position.z += gameSpeed * 2.5;
        if(wall.position.z > 15 && !isHit) handleResult(false);
    }
    composer.render();
}

setInterval(() => {
    if(timeLeft > 0) { timeLeft--; document.getElementById('timer-val').innerText = timeLeft; }
    else if(!isGameOver) { isGameOver = true; alert("TIME UP! SCORE: " + score); location.reload(); }
}, 1000);

const cam = new Camera(document.getElementById('input_video'), { onFrame: async () => { await pose.send({image: document.getElementById('input_video')}); }, width: 640, height: 480 });
init3D(); cam.start(); animate();
</script>
</body>
</html>